version: '3.8'

services:
  next_app_prod:
    container_name: next_app_prod

    # db container will start before the next_app container.
    depends_on:
      - db_prod

    # when using Docker-outside-of-Docker (DooD), you need to ensure that the paths you're using in your Dockerfile and docker-compose file are accessible from the Docker daemon running on the host machine. this is why the LOCAL_WORKSPACE_FOLDER environment variable is used to refer to the Workspace host path. (defined in the .devcontainer/devcontainer.json file.)
    # The default value . is used if its env variable is not set, so that the docker-compose.yaml file can work when it is run outside of the container.
    build:
      # On the otehr hand, your Dockerfile does not need to be modified for Docker-outside-of-Docker (DooD), because all the paths in the Dockerfile are relative to this build context.
      # where the image is built from
      context: ${LOCAL_WORKSPACE_FOLDER:-.}
      # the path to the Dockerfile to use for building the image
      dockerfile: Dockerfile.prod

    restart: always

    # This configuration is mapping the port 10000 of the Docker host (the machine running the Docker daemon, left) to the port 10000 of the Docker container (right).
    ports:
      # The 0.0.0.0 before the first colon is specifying the network interface on the Docker host where the port is exposed. 0.0.0.0 means all IPv4 addresses on the local machine. In other words, the application listening on port 10000 inside the Docker container, can be accessed via port 10000 on any network interface of the Docker host.
      - 0.0.0.0:10000:10000

    env_file:
      - ${LOCAL_WORKSPACE_FOLDER:-.}/.env.production

    networks:
      - next_app_prod_network

  db_prod:
    container_name: db_prod
    image: postgres:16

    restart: always

    volumes:
      - postgres-data:/var/lib/postgresql/data

    env_file:
      - ${LOCAL_WORKSPACE_FOLDER:-.}/.env.production

    networks:
      - next_app_prod_network

volumes:
  postgres-data:

networks:
  next_app_prod_network:
    driver: bridge
